<!doctype html>
<html lang="az">

<head>
  <meta charset="utf-8" />
  <title>ğŸ±ğŸ¶ Cat vs Dog â€” Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 720px;
      margin: 40px auto;
      padding: 0 16px
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px
    }

    .preview {
      max-width: 280px;
      margin-top: 10px;
      display: block
    }

    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #888;
      cursor: pointer
    }

    pre {
      background: #f7f7f7;
      padding: 12px;
      border-radius: 8px;
      overflow: auto
    }
  </style>
</head>

<body>
  <h1>ğŸ±ğŸ¶ Cat vs Dog â€” Demo</h1>

  <div class="card">
    <div class="row">
      <!-- istÉ™sÉ™n mobil kamera Ã¼Ã§Ã¼n capture="environment" -->
      <input id="file" type="file" accept="image/*" />
      <button id="btn">Send</button>
    </div>
    <img id="preview" class="preview" alt="" />
    <pre id="out"></pre>
  </div>

  <script>
    // ---- DÆYÄ°Å: FastAPI serverin dÉ™qiq Ã¼nvanÄ± ----
    // const API_BASE = 'http://127.0.0.1:8000';
    const API_BASE = location.hostname.includes('localhost') ? 'http://127.0.0.1:8000' : '';


    const fileInput = document.getElementById('file');
    const btn = document.getElementById('btn');
    const out = document.getElementById('out');
    const preview = document.getElementById('preview');

    // Drag & Drop (opsional)
    ; (() => {
      const card = document.querySelector('.card');
      card.addEventListener('dragover', e => { e.preventDefault(); card.style.borderColor = '#333'; });
      card.addEventListener('dragleave', () => { card.style.borderColor = '#ddd'; });
      card.addEventListener('drop', e => {
        e.preventDefault();
        card.style.borderColor = '#ddd';
        if (e.dataTransfer.files?.[0]) {
          fileInput.files = e.dataTransfer.files;
          previewSelected();
        }
      });
    })();

    fileInput.addEventListener('change', previewSelected);

    function previewSelected() {
      const f = fileInput.files?.[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) {
        out.textContent = 'XÉ™ta: YalnÄ±z ÅŸÉ™kil fayllarÄ± (image/*) qÉ™bul olunur.';
        fileInput.value = '';
        preview.removeAttribute('src');
        return;
      }
      if (f.size > 10 * 1024 * 1024) {
        out.textContent = 'XÉ™ta: Fayl Ã§ox bÃ¶yÃ¼kdÃ¼r (maksimum 10MB).';
        fileInput.value = '';
        preview.removeAttribute('src');
        return;
      }
      const url = URL.createObjectURL(f);
      preview.src = url;
      out.textContent = '';
    }

    btn.addEventListener('click', async (e) => {
      e.preventDefault();

      const f = fileInput.files?.[0];
      if (!f) return alert('Please select an image!');

      const fd = new FormData();
      fd.append('file', f);

      btn.disabled = true;
      const t0 = performance.now();
      out.textContent = 'Loading...';

      try {
        console.log('POST =>', `${API_BASE}/predict`, 'from', location.origin);
        const res = await fetch(`${API_BASE}/predict`, { method: 'POST', body: fd });

        // XÉ™ta hallarÄ±: body-ni YALNIZ BÄ°R DÆFÆ oxu
        if (!res.ok) {
          const ct = res.headers.get('content-type') || '';
          let detail = `HTTP ${res.status}`;
          try {
            if (ct.includes('application/json')) {
              const j = await res.json();
              detail = j?.detail || j?.message || JSON.stringify(j);
            } else {
              detail = await res.text();
            }
          } catch {
            // oxunmadÄ±sa, status saxla
          }
          if (res.status === 405) {
            detail =
              '405 Method Not Allowed â€” Make sure the page is opened via FastAPI and using POST /predict.';
          }
          if (res.status === 413) detail = 'File too large (maximum 10MB).';
          if (res.status === 415)
            detail = 'Only image files are accepted (image/*).';
          throw new Error(detail);
        }

        const data = await res.json(); // OK olduqda yalnÄ±z bir dÉ™fÉ™ oxu
        const t1 = performance.now();
        const ms = Math.round(t1 - t0);
        console.log('Inference time:', ms, 'ms');

        // --- Yeni: threshold + unknown mÉ™ntiqi ---
        const label = data.label; // "Cat" or "Dog"
        const probCat = data.probabilities?.Cat ?? 0;
        const probDog = data.probabilities?.Dog ?? 0;
        const mainProb = label === 'Cat' ? probCat : probDog; // seÃ§ilÉ™n class-Ä±n ehtimalÄ±
        const confidence = (mainProb * 100).toFixed(2);
        const emoji = label === 'Cat' ? 'ğŸ±' : 'ğŸ¶';
        const THRESHOLD = 0.7; // 70% altÄ±nda unknown deyÉ™cÉ™yik

        if (mainProb < THRESHOLD) {
          // Model Ã¶zÃ¼ndÉ™n Ã§ox É™min deyil
          out.innerHTML = `
<strong style="font-size:20px;">Result:</strong><br>
<span style="font-size:18px;">ğŸ¤” Unknown â€” low confidence (${confidence}%)</span><br>
<span style="font-size:13px; color:#6b7280;">Model is not sure if this is a cat or a dog.</span>
      `;
          out.style.color = '#4b5563'; // boz
        } else {
          // Normal halda: Cat vÉ™ ya Dog
          out.innerHTML = `
<strong style="font-size:20px;">Result:</strong><br>
<span style="font-size:18px;">${emoji} ${label} â€” ${confidence}%</span>
      `;
          out.style.color = label === 'Cat' ? 'purple' : 'blue';
        }

        out.style.transition = '0.3s ease';
      } catch (err) {
        out.textContent = 'Error: ' + (err.message || err);
        out.style.color = 'red';
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>

</html>